<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AHA Guidelines</title>
    <style>
      :root {
        color: #0b0b0f;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
      }

      html,
      body {
        width: 100%;
        min-height: 100%;
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 16px;
        background: #f6f8fb;
      }

      main {
        width: 100%;
        max-width: 600px;
        min-height: 300px;
        margin: 0 auto;
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      }

      h2 {
        margin: 0 0 20px;
        font-size: 1.5rem;
        color: #c8102e;
        font-weight: 700;
      }

      .search-container {
        margin-bottom: 20px;
      }

      form {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }

      form input {
        flex: 1;
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #cad3e0;
        font-size: 0.95rem;
      }

      form button {
        border: none;
        border-radius: 10px;
        background: #c8102e;
        color: white;
        font-weight: 600;
        padding: 0 20px;
        cursor: pointer;
        transition: background 0.2s;
      }

      form button:hover {
        background: #a00d26;
      }

      form button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .results-container {
        margin-top: 20px;
      }

      .result-item {
        background: #f2f4fb;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid #c8102e;
      }

      .result-title {
        font-weight: 600;
        margin-bottom: 8px;
        color: #0b0b0f;
        font-size: 1rem;
      }

      .result-content {
        color: #4a5568;
        line-height: 1.6;
        font-size: 0.9rem;
      }

      .result-source {
        margin-top: 8px;
        font-size: 0.85rem;
        color: #6c768a;
        font-style: italic;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #6c768a;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c768a;
      }

      .empty-state p {
        margin: 8px 0;
      }

      .query-display {
        background: #e8f0fe;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        font-size: 0.9rem;
        color: #0b0b0f;
      }

      .query-display strong {
        color: #c8102e;
      }
    </style>
  </head>
  <body>
    <main>
      <h2>American Heart Association Guidelines</h2>
      
      <div class="search-container">
        <form id="query-form" autocomplete="off">
          <input 
            id="query-input" 
            name="query" 
            placeholder="Ask about AHA guidelines, recommendations, or protocols..." 
            autocomplete="off"
          />
          <button type="submit" id="submit-btn">Search</button>
        </form>
      </div>

      <div id="query-display" class="query-display" style="display: none;">
        <strong>Query:</strong> <span id="current-query"></span>
      </div>

      <div id="results-container" class="results-container">
        <div class="empty-state">
          <p>Enter a query to search AHA guidelines and documents.</p>
          <p style="font-size: 0.85rem; margin-top: 8px;">
            All responses are based solely on AHA-approved documents and guidelines.
          </p>
        </div>
      </div>
    </main>

    <script type="module">
      const resultsContainer = document.querySelector("#results-container");
      const queryForm = document.querySelector("#query-form");
      const queryInput = document.querySelector("#query-input");
      const submitBtn = document.querySelector("#submit-btn");
      const queryDisplay = document.querySelector("#query-display");
      const currentQuerySpan = document.querySelector("#current-query");

      let currentResults = window.openai?.toolOutput?.results ?? [];
      let currentQuery = window.openai?.toolOutput?.query ?? "";

      const render = () => {
        if (currentQuery) {
          queryDisplay.style.display = "block";
          currentQuerySpan.textContent = currentQuery;
        } else {
          queryDisplay.style.display = "none";
        }

        if (currentResults.length === 0) {
          resultsContainer.innerHTML = `
            <div class="empty-state">
              <p>Enter a query to search AHA guidelines and documents.</p>
              <p style="font-size: 0.85rem; margin-top: 8px;">
                All responses are based solely on AHA-approved documents and guidelines.
              </p>
            </div>
          `;
          return;
        }

        resultsContainer.innerHTML = currentResults
          .map(
            (result) => `
            <div class="result-item">
              <div class="result-title">${escapeHtml(result.title || "Document Excerpt")}</div>
              <div class="result-content">${escapeHtml(result.content || result.text || "")}</div>
              ${result.source ? `<div class="result-source">Source: ${escapeHtml(result.source)}</div>` : ""}
            </div>
          `
          )
          .join("");
      };

      const escapeHtml = (text) => {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      };

      const updateFromResponse = (response) => {
        if (response?.structuredContent) {
          if (response.structuredContent.results) {
            currentResults = response.structuredContent.results;
          }
          if (response.structuredContent.query) {
            currentQuery = response.structuredContent.query;
          }
          render();
        }
      };

      const handleSetGlobals = (event) => {
        const globals = event.detail?.globals;
        if (!globals?.toolOutput) return;

        if (globals.toolOutput.results) {
          currentResults = globals.toolOutput.results;
        }
        if (globals.toolOutput.query) {
          currentQuery = globals.toolOutput.query;
        }
        render();
      };

      window.addEventListener("openai:set_globals", handleSetGlobals, {
        passive: true,
      });

      const showLoading = () => {
        resultsContainer.innerHTML = '<div class="loading">Searching AHA guidelines...</div>';
        submitBtn.disabled = true;
      };

      const hideLoading = () => {
        submitBtn.disabled = false;
      };

      const callQueryTool = async (query) => {
        if (window.openai?.callTool) {
          showLoading();
          try {
            const response = await window.openai.callTool("query_aha_guidelines", { query });
            updateFromResponse(response);
          } catch (error) {
            console.error("Error calling tool:", error);
            resultsContainer.innerHTML = `
              <div class="empty-state">
                <p style="color: #c8102e;">Error: ${escapeHtml(error.message || "Failed to query guidelines")}</p>
              </div>
            `;
          } finally {
            hideLoading();
          }
          return;
        }

        // Fallback for local testing
        showLoading();
        setTimeout(() => {
          currentResults = [
            {
              title: "Sample Result",
              content: "This is a sample result. In production, this would come from the AHA guidelines database.",
              source: "AHA Guidelines Database"
            }
          ];
          currentQuery = query;
          render();
          hideLoading();
        }, 500);
      };

      queryForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const query = queryInput.value.trim();
        if (!query) return;

        await callQueryTool(query);
        queryInput.value = "";
      });

      // Initialize with any existing data
      render();
    </script>
  </body>
</html>




